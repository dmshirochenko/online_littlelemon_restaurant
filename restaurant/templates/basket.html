{% extends 'base.html' %}
{% load static %}

{% block content %}
<h1>Your Basket</h1>
<div class="column">

    <div id="basket-container"></div> <!-- This is used for both authenticated and non-authenticated users -->

</div>

<script>

// Function to format individual basket items
function formatBasketData(item) {
    return `
        <h3>
            <a href="#" id="menuitem_${item.menuitem}" data-base-url="{% url 'menu_item' pk=0 %}">
                ${item.menuitem_details.title}
            </a>
        </h3>
        <span class="basket-info">
            <span class="basket-price">Unit Price: $${item.unit_price}</span>
            <!-- Quantity Selector -->
            <div class="component-container">
                <button class="minus-button" onclick="updateQuantity('decrement', item)">âˆ’</button>
                <span class="quantity-display" id="quantity_${item.menuitem}">${item.quantity}</span>
                <button class="plus-button" onclick="updateQuantity('increment', item)">+</button>
                <button class="action-button" onclick="updateBasket(item)">Update $${item.price}</button>
            </div>
        </span>
    `;
}

// Function to render basket items on the page
function renderBasketItems(basketItems) {
    const basketContainer = document.getElementById('basket-container');
    basketItems.forEach(item => {
        const basketItem = document.createElement('div');
        basketItem.className = "basket-item";
        basketItem.innerHTML = formatBasketData(item);
        
        // Update href for the menu item link
        const menuItemLink = basketItem.querySelector(`#menuitem_${item.menuitem}`);
        const baseUrl = menuItemLink.getAttribute('data-base-url');
        menuItemLink.href = baseUrl.slice(0, -2) + item.menuitem_details.id + '/';
        
        basketContainer.appendChild(basketItem);
    });
}

function transformLocalData(data) {
    return data.map(item => {
        return {
            menuitem: item.menuitem,
            menuitem_details: {
                title: item.title,
                id: item.menuitem  // assuming menuitem contains the id
            },
            unit_price: item.unit_price,
            quantity: item.quantity,
            price: item.price
        };
    });
}

function fetchBasket() {
    if (sessionStorage.getItem('token')) {
        const authToken = sessionStorage.getItem('token');
        fetch('/api/cart/menu-items', {
            method: 'GET',
            headers: {
                'Authorization': `Token ${authToken}`,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            renderBasketItems(data.results);
        })
        .catch(error => {
            console.error('Error fetching cart:', error);
        });
    } else {
        const localBasket = localStorage.getItem('clientBasket') ? JSON.parse(localStorage.getItem('clientBasket')) : [];
        const transformedLocalBasket = transformLocalData(localBasket);
        renderBasketItems(transformedLocalBasket);
    }
}

function updateQuantity(action, item) {
    const quantityDisplay = document.getElementById('quantity_' + item.menuitem);
    let quantity = parseInt(quantityDisplay.textContent);
    if (action === 'decrement' && quantity > 1) {
        quantity--;
    } else if (action === 'increment') {
        quantity++;
    }
    quantityDisplay.textContent = quantity;
    item.quantity = quantity;
    const actionButton = quantityDisplay.closest('.component-container').querySelector('.action-button');
    actionButton.textContent = `Update $${(item.unit_price * quantity).toFixed(2)}`;
}

function updateBasket(item) {
    const authToken = sessionStorage.getItem('token');
    if (authToken) {
        // Authenticated User: Update server-side basket
        // ... [your existing logic for authenticated users]
    } else {
        // Non-authenticated User: Update localStorage
        // ... [your existing logic for non-authenticated users]
    }
}

document.addEventListener('DOMContentLoaded', () => {
    fetchBasket();
});

</script>
{% endblock %}
